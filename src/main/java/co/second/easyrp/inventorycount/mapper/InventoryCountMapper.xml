<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper
	namespace="co.second.easyrp.inventorycount.mapper.InventoryCountMapper">
	<select id="inventoryCountList">
SELECT 
			i.cod,
			e.name AS employee,
			w.name AS warehouse,
			l.name AS location,
			ic.count_date,
			ic.inv_date,
			ic.countclass,
		FROM inventorycount ic
		LEFT JOIN inventorycountdetail icd
		ON ic.cod = icd.inventorycount_cod
		LEFT JOIN inventory i
		ON icd.inventory_cod = i.cod
		LEFT JOIN product p
		ON icd.product_cod = p.cod
		LEFT JOIN employee e
		ON ic.employee_cod = e.cod
		LEFT JOIN warehouse w
		ON ic.warehouse_cod = w.cod
		LEFT JOIN location l
		ON ic.location_cod = l.cod
		WHERE ic.deleteyn = 'N'
		<if test="searchCod != null and searchCod != ''">
			AND ic.cod = #{searchCod}
		</if>
		<if test="searchEmployee != null and searchEmployee != ''">
			AND employee LIKE CONCAT('%', #{searchEmployee}, '%')
		</if>
		<if test="searchWarehouse != null and searchWarehouse != ''">
			AND warehouse LIKE CONCAT('%', #{searchWarehouse}, '%')
		</if>
		<if test="searchLocation != null and searchLocation != ''">
			AND location LIKE CONCAT('%', #{searchLocation}, '%')
		</if>
		<if test="searchInventory != null and searchInventory != ''">
			AND i.name = #{searchInventory}
		</if>
				<if test="searchProduct!= null and searchProduct != ''">
			AND p.name = #{searchProduct}
		</if>
		<if test="preSearchDate != null and postSearchDate != null">
			AND ic.count_date BETWEEN #{preSearchDate} AND #{postSearchDate}
		</if>
		ORDER BY ic.cod DESC
		LIMIT #{pageSize} OFFSET #{offset}
	</select>
	<select id="countInventoryCountLists">
SELECT 
			count(*)
		FROM inventorycount ic
		LEFT JOIN inventorycountdetail icd
		ON ic.cod = icd.inventorycount_cod
		LEFT JOIN inventory i
		ON icd.inventory_cod = i.cod
		LEFT JOIN product p
		ON icd.product_cod = p.cod
		LEFT JOIN employee e
		ON ic.employee_cod = e.cod
		LEFT JOIN warehouse w
		ON ic.warehouse_cod = w.cod
		LEFT JOIN location l
		ON ic.location_cod = l.cod
		WHERE ic.deleteyn = 'N'
		<if test="searchCod != null and searchCod != ''">
			AND ic.cod = #{searchCod}
		</if>
		<if test="searchEmployee != null and searchEmployee != ''">
			AND employee LIKE CONCAT('%', #{searchEmployee}, '%')
		</if>
		<if test="searchWarehouse != null and searchWarehouse != ''">
			AND warehouse LIKE CONCAT('%', #{searchWarehouse}, '%')
		</if>
		<if test="searchLocation != null and searchLocation != ''">
			AND location LIKE CONCAT('%', #{searchLocation}, '%')
		</if>
		<if test="searchInventory != null and searchInventory != ''">
			AND i.name = #{searchInventory}
		</if>
				<if test="searchProduct!= null and searchProduct != ''">
			AND p.name = #{searchProduct}
		</if>
		<if test="preSearchDate != null and postSearchDate != null">
			AND ic.count_date BETWEEN #{preSearchDate} AND #{postSearchDate}
		</if>
		</select>
		<select id="selectInventoryCountList">
		SELECT ic.cod, ic.count_date, ic.inv_date, w.name as warehouse, l.name as location, countclass, e.name as employee
		  FROM inventorycount ic
		  LEFT JOIN employee e
		    ON e.cod = ic.employee_cod
		  LEFT JOIN warehouse w
		 	ON w.cod = ic.warehouse_cod
		  LEFT JOIN location l
		    ON l.cod = ic.location_cod
		 WHERE deleteyn = 'N'
		   AND cod= #{cod}

		</select>
		<select id="selectedInventoryCountDetailList">
		SELECT num, inventorycount_cod, product_cod, spec
		  FROM inventorycountdetail icd
		LEFT JOIN inventorycount ic
		  ON icd.inventorycount_cod = ic.cod
		LEFT JOIN product p
		  ON icd.product_cod = p.cod
		LEFT JOIN inventory i
		  ON icd.inventory_cod = i.cod
		LEFT JOIN unit u
		  ON icd.unit_cod = u.cod
		LEFT JOIN adjustmentdetail_num=
		</select>
	<select id="getAllProductInventoryList">
		 SELECT  p.prodname as name, p.cod as cod, p.cur_inv_qty as computingQty, ia.procclass
		 FROM product p
		 LEFT JOIN inventorycountdetail icd
		 ON icd.inventory_cod = p.cod
		 LEFT JOIN inventoryadjustmentdetail iad
		 ON icd.adjustmentdetail_num = iad.num
		 LEFT JOIN inventoryadjustment ia
		 ON ia.cod = iad.inventoryadjustment_cod
		 
		 UNION 
		 
		 SELECT i.name as name, i.cod as cod, i.cur_inv_qty as computingQty, ia.procclass
		 FROM inventory i
		 LEFT JOIN inventorycountdetail icd
		 ON icd.inventory_cod = i.cod
		 LEFT JOIN inventoryadjustmentdetail iad
		 ON icd.adjustmentdetail_num = iad.num
		 LEFT JOIN inventoryadjustment ia
		 ON ia.cod = iad.inventoryadjustment_cod
	</select>
	<select id="getAllSelectedCountList">
		 SELECT  p.prodname as name, p.cod as cod, p.cur_inv_qty as computingQty, ia.procclass
		 FROM product p
		 LEFT JOIN inventorycountdetail icd
		 ON icd.inventory_cod = p.cod
		 LEFT JOIN inventoryadjustmentdetail iad
		 ON icd.adjustmentdetail_num = iad.num
		 LEFT JOIN inventoryadjustment ia
		 ON ia.cod = iad.inventoryadjustment_cod
		 WHERE p.cod=#{cod}

		 UNION 
		 
		 SELECT i.name as name, i.cod as cod, i.cur_inv_qty as computingQty, ia.procclass
		   FROM inventory i
		 LEFT JOIN inventorycountdetail icd
		 	 ON icd.inventory_cod = i.cod
		 LEFT JOIN inventoryadjustmentdetail iad
		 	 ON icd.adjustmentdetail_num = iad.num
		 LEFT JOIN inventoryadjustment ia
		 	 ON ia.cod = iad.inventoryadjustment_cod
		 WHERE i.cod=#{cod}
	</select>
	<insert id="insertInventoryCount">
		INSERT INTO inventorycount 
		Values(#{cod}, #{employeeCod}, #{countDate}, #{invDate}, #{warehouseCod}, #{countclass}, #{deleteyn})
	</insert>
	<insert id="insertCountDetailList">
		INSERT INTO inventorycountdetail(inventorycount_cod, product_cod, inventory_cod, spec, unit_cod, qty, note, diff_qty)
		Values(#{inventorycountCod}, #{productCod}, #{inventoryCod}, #{unitCod}, #{qty}, #{account}, #{note}, #{diffQty}-#{computingQty})
	</insert>
	<select id="warehouseList">
	 SELECT cod, name
	   FROM warehouse
	</select>
	<select id="getAllProdInvWarehouse">
		 SELECT  p.prodname as name, p.cod as cod, p.cur_inv_qty as computingQty, ia.procclass, p.account
		 FROM product p
		 LEFT JOIN inventorycountdetail icd
		 ON icd.inventory_cod = p.cod
		 LEFT JOIN inventoryadjustmentdetail iad
		 ON icd.adjustmentdetail_num = iad.num
		 LEFT JOIN inventoryadjustment ia
		 ON ia.cod = iad.inventoryadjustment_cod
		 LEFT JOIN warehouse w
		 ON w.cod = p.warehouse_cod
		 WHERE w.name=#{name}
		   AND 

		 UNION 
		 
		 SELECT i.name as name, i.cod as cod, i.cur_inv_qty as computingQty, ia.procclass, i.account
		   FROM inventory i
		 LEFT JOIN inventorycountdetail icd
		 	 ON icd.inventory_cod = i.cod
		 LEFT JOIN inventoryadjustmentdetail iad
		 	 ON icd.adjustmentdetail_num = iad.num
		 LEFT JOIN inventoryadjustment ia
		 	 ON ia.cod = iad.inventoryadjustment_cod
		 LEFT JOIN warehouse w
		 	 ON w.cod = i.warehouse_cod
		 WHERE w.name=#{name}
	</select>
		<select id="selectedWarehouseList">
	 SELECT cod, name
	   FROM warehouse
	 WHERE name=#{name}
	</select>
		<select id="wareHouseCod">
        SELECT cod FROM warehouse WHERE name = #{name}
    </select>
	<select id="getProdInvAccount">
		 SELECT  p.prodname as name, p.cod as cod, p.cur_inv_qty as computingQty, ia.procclass, p.account
		 FROM product p
		 LEFT JOIN inventorycountdetail icd
		 ON icd.inventory_cod = p.cod
		 LEFT JOIN inventoryadjustmentdetail iad
		 ON icd.adjustmentdetail_num = iad.num
		 LEFT JOIN inventoryadjustment ia
		 ON ia.cod = iad.inventoryadjustment_cod
		 LEFT JOIN warehouse w
		 ON w.cod = p.warehouse_cod
		 WHERE p.account=#{account}
		   AND w.name=#{warehouse}

		 UNION 
		 
		 SELECT i.name as name, i.cod as cod, i.cur_inv_qty as computingQty, ia.procclass, i.account
		   FROM inventory i
		 LEFT JOIN inventorycountdetail icd
		 	 ON icd.inventory_cod = i.cod
		 LEFT JOIN inventoryadjustmentdetail iad
		 	 ON icd.adjustmentdetail_num = iad.num
		 LEFT JOIN inventoryadjustment ia
		 	 ON ia.cod = iad.inventoryadjustment_cod
		 LEFT JOIN warehouse w
		 	 ON w.cod = i.warehouse_cod
		 WHERE i.account=#{account}
		   AND w.name=#{warehouse}
	</select>
	<select id="selectMaxCod">
	SELECT COALESCE(MAX(CAST(RIGHT (cod,3) AS SIGNED)), 0) AS cod 
	FROM inventorycount
	</select>
</mapper>